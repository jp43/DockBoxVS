#!/usr/bin/env python
import os
import sys
import argparse

from glob import glob
import pandas as pd

#TODO: add the possibilty to prepare scripts for torque and ll
parser = argparse.ArgumentParser(description="Check VS!")

parser.add_argument('-w',
    dest='vsdir',
    type=str,
    default='vs',
    metavar='DIRECTORY NAME',
    help='name of directory created for virtual screening')

args = parser.parse_args()
vsdir = args.vsdir

tosubdir = 'to_submit_' + vsdir
compound_dir = 'compounds'

if not os.path.isdir(vsdir):
    sys.exit('Working directory %s does not exist'%vsdir)

if not os.path.isdir(tosubdir):
    sys.exit('Working directory %s does not exist'%tosubdir)

vs_done = True
files_to_submit = glob(tosubdir+'/run_vs_*')
suff, ext = os.path.splitext(files_to_submit[0])
suff = '_'.join(suff.split('_')[:-1])

indices = []
ligIDs = {}
for ff in files_to_submit:
    base = os.path.basename(ff)
    index = int((base.split('.')[0]).split('_')[-1])
    file_to_submit = suff + '_' + str(index) + ext
    with open(file_to_submit, 'r') as ff:
         is_ligID = False
         for line in ff:
             if line.startswith("declare -a files_l"):
                 line_s = line.split('../../../')
                 ligIDs[index] = [dir.split('/')[1] for dir in line_s[1:]]
                 is_ligID = True
         if not is_ligID:
             ligIDs[index] = None
    indices.append(index)
indices = sorted(indices)

csvfiles = glob(vsdir+'/*.csv')
programs = list(set([os.path.basename(ff).split('_')[0] for ff in csvfiles]))

suff, ext = os.path.splitext(files_to_submit[0])
for index in indices:
    for prgm in programs:
        csvfile = vsdir + '/' + prgm + '_%i.csv'%index 
        if os.path.isfile(csvfile):
            df = pd.read_csv(csvfile)
            ligIDs_csv = df["ligID"].values
            for ligid in ligIDs[index]:
                if ligid not in ligIDs_csv:
                    vs_done = False
                    print "%s not found in csv file %s"%(ligid, csvfile)
                    break
        else:
            vs_done = False
            print "File %s not found!"%csvfile

if vs_done:
    print "Virtual screening finished correctly!"
